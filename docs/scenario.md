# Алгоритм работы

- **ШАГ 0.** Оператор включает ПК и запускает программу через ярлык на рабочем столе, который запускает главный скрипт `main.py` в командной строке.
  - Есть две опции запуска программы: в обычном режиме и в режиме отладки (параметр --dubug или -d).
  - Открывается новая сессия программы, фиксируется время начала сессии.
- **ШАГ 1.** Программа инициализирует рабочую среду.
  - Проверяет версию Python и наличие модулей, установленных в системе необходимых для работы программы.
    - Если не находит, предлагает установить, приводит пример команды в командной строке.
  - Ищет рядом с файлом `main.py` файл конфигурации `config.ini`.
    - Если его не находит, создает заново с базовыми настройками.
  - Считывает параметры конфигурации.
    - Конфигурация может быть считана тремя способами, в порядке повышения приоритета:
      - Через создание файла с базовыми настройками.
      - Через существующий файл конфигурации.
      - Через параметры вызова скрипта `main.py` (высший приоритет).
  - Проверяет указанные в `config.ini` пути к папкам.
    - Если их нет, выводит сообщение об этом и спрашивает, нужно ли создать эти директории.
      - Если пользователь соглашается, создает эти директории.
      - Если нет, просит обновить файл конфигурации и завершает работу.
- **ШАГ 2.** Программа запрашивает ФИО оператора или предлагает использовать ФИО по умолчанию из файла конфигурации.
  - Сохраняет ФИО оператора на период всей сессии.
- **ШАГ 3.** Программа запрашивает номер заказа.
  - Номер заказа содержит комбинацию цифр, количество цифр задается в `config`.
    - Пример ввода генерируется случайным образом под количество цифр.
  - Номер введенного заказа сохраняется на период всей сессии, до тех пор пока его не изменит пользователь.
    - Можно запустить программу с предуказанным номером заказа в параметрах, тогда в этом шаге программа выводит заданный номер заказа, не запрашивая его у пользователя.
- **ШАГ 4.** Программа ищет Gerber-файл с указанным номером заказа в папке, указанной в `config`.
  - Название Gerber-файла может содержать номер в любом месте. Возможные варианты: `332344pencil.gbr`, `CL_0094_totem.gbr`, `capureHello44033122.gbr`. (Количество ожидаемых цифр задается в `config`).
  - Если файл найден, программа сообщает об этом и переходит к следующему **ШАГУ 5**.
    - Если в папке найдены несколько файлов с номером заказа, то применяется заданное правило из `config`:
      - Берется первый файл по алфавиту.
      - Берется последний файл по дате изменения.
      - Выводится сообщение, что найдено несколько файлов (выводится список), и какой взять в работу в зависимости от опции.
  - Если файл не найден, программа сообщает об этом и предлагает ввести новый номер или завершить работу.
- **ШАГ 5.** Программа приступает к парсингу Gerber-файла.
  - Если парсинг прошел успешно, программа выводит:
    - размеры платы;
    - количество найденных на ней элементов;
    - размер самого маленького и самого большого элемента в мм;
    - суммарную площадь полигонов.
  - Результаты парсинга (массив полигонов) и словарь выходных данных сохраняются в памяти до конца работы с заказом.
  - Если парсинг не удался, программа предлагает:
    - Вывести причину неудачи (если это запрограммировано).
    - Проверить файл и запустить парсинг повторно с тем же номером заказа (возврат к **ШАГУ 4**).
    - Ввести новый номер заказа (возврат к **ШАГУ 3**).
    - Выйти.
  - На этом шаге не выполняется растеризация изображения Gerber-файла, работа ведется только с векторынми данными.
- **ШАГ 6.** Программа просит пользователя провести сканирование трафарета и ожидает появление файла изображения (скана) в указанной в `config` папке.
  - Приводит инструкцию сканирования (задается в `config`), например: "Установите разрешение 1200 dpi, проверьте ориентацию, совместите трафарет по маркерам на столе".
  - Проверяет появление файла каждые 3 секунды (указывается в `config`).
  - Как только файл получен, программа проверяет, что это изображение, и выводит:
    - Имя файла;
    - Если в метаданных указаны DPI или PPI, выводится значение DPI/PPI;
    - Размер изображения в пикселях и мм:
      - Если в метаданных указаны DPI или PPI, выводится значение DPI/PPI;
      - Если таких метаданных нет, разрешение считается 600 DPI (задается по умолчанию в `config`);
      - Также в `config` указывается, какое значение разрешения является приоритетным: из метаданных или из конфига (так как в метаданных скана могут быть неверные значения).
    - Также выводится размер файла адаптивно: в байтах, мегабайтах, гигабайтах.
  - Здесь также присутствует программная заглушка для будущего функционала запуска сканирования в автоматическом режиме.
- **ШАГ 7.** После получения файла скана программа приступает к проверке и предобработке изображения, выделению ROI (области интереса) и обрезке изображения по ней.
  - Для фильтрации контуров по размеру программа использует данные из **ШАГА 5** (парсинга Gerber-файла).
  - Проверяются результаты предобработки:
    - Предобработка считается невыполненной, если не удалось найти контуры, их слишком мало или возникли ошибки в процессе бинаризации и т.д.
      - Выводится сообщение, что проверка файла не прошла, и предлагается повторить сканирование, выбрать новый заказ или выйти.
        - Если пользователь выбирает повторное сканирование, программа возвращается к **ШАГУ 6** (ожидание нового файла).
        - Если пользователь выбирает новый заказ, программа возвращается к **ШАГУ 3** (задание номера заказа).
    - Предобработка считается выполненной частично, если размеры скана после обрезки не совпадают с размерами эталона (допуск задается в `config`). Размеры скана пересчитываются в мм согласно метаданным DPI/PPI или значению в `config`. Учитывается, что скан может быть развернут относительно эталона на 90 градусов.
      - Выводится предупреждающее сообщение о разнице размеров: исходные размеры скана, размеры после обрезки, размеры эталона, их разница и допуск из `config`.
      - Далее, в зависимости от настроек в `config` (что делать в случае частичной предобработки):
        - По умолчанию предупреждение игнорируется, и программа переходит к следующему этапу.
        - Если в `config` указано прерываться на этом этапе, программа останавливается и спрашивает пользователя: продолжить, сканировать заново, выбрать новый заказ или выйти.
          - Если продолжить — продолжаем.
          - Если сканировать заново — возврат к **ШАГУ 6**.
          - Если выбрать новый заказ — возврат к **ШАГУ 3**.
    - В противном случае предобработка считается пройденной успешно. Выводится сообщение об успешной предобработке, размер трафарета в мм до обрезки и после обрезки, а также % обрезки. Результат предобработки (бинарное изображение скана) сохраняется в память.
- **ШАГ 8.** Выполняется синтез бинарного изображения эталона (на основе данный Gerber-файла) с разрешением DPI/PPI, взятым из метаданных скана или `config` (в зависимости от настроек). Выводится сообщение о размерах изображения эталона в пикселях, мм и значении DPI/PPI.
- **ШАГ 9.** Самый важный шаг: сравнение бинарных изображений эталона и скана.
  - Настройки сравнения задаются в `config`:
    - Нужно ли учитывать отражение (переворот) скана или только поворот на 0, 90, 180, 270 градусов.
    - Размер минимального контура относительно минимального размера полигона на плате (который был получен на **ШАГЕ 5** парсинга). Задается коэффициентом от 1.0x до 10x. По этому фильтру будет работать совмещение.
    - Параметры для `cv2.estimateAffine2D`: `ransacReprojThreshold`, `maxIters`, `confidence`, `refineIters`.
    - Пороги результирующей корреляции эталона и скана:
      - Низкий порог — совмещение не удалось (до 0,2).
      - Средний диапазон — совмещение либо не удалось, либо большой брак (до 0,4).
  - Формируются и проверяются результаты совмещения:
    - Если корреляция отрицательная или ниже низкого порога, выводится сообщение, что совмещение не удалось, и предлагается либо повторить сканирование (**ШАГ 6**), либо ввести новый номер заказа (**ШАГ 3**), либо выйти.
    - Если корреляция в диапазоне от низкого до среднего порога, выводится сообщение, что совмещение либо не удалось, либо между сканом и эталоном очень высокое различие. Пользователю предлагается либо повторить сканирование, либо ввести другой номер заказа, либо выйти.
    - Если корреляция выше среднего диапазона, выводится сообщение, что совмещение удалось, и выводится результат корреляции.
    - Если был включен режим отладки, дополнительно выводится:
      - Угол поворота и расстояние по X и Y для совмещения скана с эталоном.
- **ШАГ 10.** При любом результате на экран выводится результат совмещения: - Результат совмещения — это эталон, окрашенный в цвет А (красный), сверху на него наложен выравненный скан, окрашенный в цвет Б (голубой), и сверху их пересечение, окрашенное в цвет В (белый). Цвета А, Б и В задаются в файле конфигурации в RGB. - Также на изображении совмещения сверху есть поле, в котором выводится номер заказа, дата и время сравнения, ФИО оператора и результат.
- **ШАГ 11.** Происходит завершение работы над заказом с сохранением результатов в зависимости от настроек `config`.
  - В `config` указана папка вывода результатов.
  - Если в `config` включена опция создания отдельной подпапки заказа, она создается внутри папки вывода. Имя папки соответствует номеру заказа и таймкоду его завершения, и результаты складываются в неё.
    - Если создание подпапок отключено, результаты сохраняются в общую папку результатов с именем `XXXXX_work`.
  - Если в `config` включена опция сохранения всех промежуточных изображений, на диск сохраняются:
    - Изображение бинарного эталона с именем `XXXXX_1_gerber.png`.
    - Изображение исходного скана с именем `XXXXX_2_scan.png`.
    - Изображение бинарного обрезанного скана с именем `XXXXX_3_scan_prep.png`.
    - `XXXXX` — номер заказа, названия всех файлов задаются в `config`, номер заказа может иметь другое количество цифр.
      - Если запуск программы проходил в режиме отладки, эта опция включается автоматически.
  - Если в `config` включена опция сохранения финального изображения, сохраняется совмещенное цветное изображение эталона и скана с именем `XXXXX_4_compared.png`.
  - В `config` может быть задано ведение лога заказа в трех опциях:
    - Не вести лог заказа.
    - Вести краткий лог:
      - Сохраняется краткий лог, в котором указано (шаблон краткого лога задается в `config`). Имя файла лога: `XXXXX_6_log_short.txt`.
        - Дата и время завершения совмещения.
        - ФИО оператора.
        - Результат совмещения из **ШАГА 10**.
    - Вести подробный лог, в котором, помимо краткого лога, сохраняется вся информация, которая была выведена на экран в процессе работы сессии. Имя файла лога: `XXXXX_5_log_details.txt`.
      - Если был включен режим отладки, в подробный лог сохраняется также результат вывода отладочных сообщений.
  - Если какие-то файлы были созданы, выводится сообщение о создании файлов.
    - В `config` указывается опция, что делать при повторном создании файлов: перезаписывать их или инкрементировать в названии (`_1`, `_2` и т.д.).
- **ШАГ 12.** Выводится главное меню, которое предлагает либо ввести новый номер заказа (**ШАГ 3**), либо выйти.
